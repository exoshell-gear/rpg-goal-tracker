<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Personal RPG Map</title>

<style>

.panel {
  background: radial-gradient(circle at top, #181818, #0e0e0e);
  box-shadow: 0 20px 60px rgba(0,0,0,.6);
}

.task {
  display: grid;
  grid-template-columns: 20px minmax(0, 1fr) 28px;
  align-items: start;
  gap: 12px;
  padding: 8px 0;
}

.task span {
  font-size: 14px;
  text-align: left;
  width: 100%;
  line-height: 1.4;
  white-space: normal;
  word-break: normal;
  overflow-wrap: anywhere;
  cursor: pointer;
}

.task button {
  align-self: start;
  margin-top: 2px;
}

.task input[type="checkbox"] {
  transform: scale(1.1);
}

.task button {
  background: none;
  border: none;
  color: #555;
  cursor: pointer;
}

.task button:hover {
  color: #ff5555;
}

.task input:checked + span {
  opacity: 0.5;
  text-decoration: line-through;
}

.panel h3 {
  margin-top: 0;
  margin-bottom: 12px;
  letter-spacing: 0.05em;
  font-size: 13px;
  text-transform: uppercase;
  color: #aaa;
}


  body {
    margin: 0;
    background: black;
    overflow: hidden;
    font-family: sans-serif;
  }

  #map {
  position: relative;
  width: 100vw;
  height: 100vh;
  background-position: center;
  background-repeat: no-repeat;
  background-size: cover;
}

.map-switcher {
  position: fixed;
  top: 12px;
  right: 12px;
  left: auto;
  z-index: 20;
  width: auto;
  max-width: 160px;
  background: #111;
  color: #fff;
  border: 1px solid #333;
  padding: 4px 8px;
  font-size: 13px;
}


  #avatar {
    position: absolute;
    width: 96px;
    height: 96px;
    user-select: none;
    cursor: pointer;
  }

  .milestone {
    position: absolute;
    user-select: none;
    cursor: pointer;
  }

  .milestone img {
    width: 96px;
    height: 96px;
    pointer-events: none;
  }
  
  .milestone.dragon img {
  width: 256px;
  height: 256px;
}


  #modal, #context {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.6);
    display: none;
    align-items: center;
    justify-content: center;
  }

  .panel {
  background: #111;
  color: white;
  padding: 20px;
  width: 520px;
  max-width: 90vw;
  border-radius: 8px;
}

  input, textarea, select {
    width: 100%;
    margin-bottom: 8px;
    background: #222;
    color: white;
    border: none;
    padding: 6px;
  }

  button {
    width: 100%;
    margin-top: 8px;
  }
  
  button.danger {
  width: auto;
  padding: 6px 12px;
  margin-top: 12px;
  background: #1a1a1a;
  color: #ff6666;
  border: 1px solid #333;
  font-size: 13px;
  cursor: pointer;
}

button.danger:hover {
  background: #220;
  border-color: #ff6666;
}

</style>
</head>

<body>

<select id="mapSelect" class="map-switcher">
  <option value="mountain">Mountain</option>
  <option value="volcano">Volcano</option>
  <option value="temple">Temple</option>

</select>


<div id="map">
  <img id="avatar" src="avatar.png">
</div>

<div id="modal"><div class="panel" id="modalContent"></div></div>
<div id="context"><div class="panel" id="contextContent"></div></div>

<script>

let touchStartX = 0;
let touchStartY = 0;

let touchMoved = false;

let touchId = null;

let isDraggingAvatar = false;

function isModalOpen() {
  return modal.style.display === "flex" || context.style.display === "flex";
}

function killDrag() {
  dragTarget = null;
  touchMoved = false;
  isDraggingAvatar = false;
}


const maps = {
  mountain: "mountain-map.png",
  temple: "temple-map.png",
  volcano: "lava-map.png"
};

const autoPairs = {
  enemy: "reward",
  dragon: "treasure"
};

const icons = {
  regular: "icons/milestone.png",
  start: "icons/start.png",
  enemy: "icons/enemy.png",
  reward: "icons/reward.png",
  dragon: "icons/dragon.png",
  mentor: "icons/mentor.png",
  sidequest: "icons/sidequest.png",
  treasure: "icons/treasure.png"
};

const milestoneHelp = {
  regular: "A step in the journey",
  start: "Your current state",
  enemy: "Something you are avoiding",
  dragon: "The big end goal",
  treasure: "Something nice you wouldn't normally do for yourself",
  reward: "Your guilty pleasure",
  mentor: "A book, a coach, a friend",
  sidequest: "Optional mini journey"
};


let state = JSON.parse(localStorage.getItem("rpgState")) || {
  currentMap: "forest",
  avatar: { x: 120, y: 120, name: "You", notes: "" },
  milestones: []

};

function setMap(key) {
  state.currentMap = key;
  map.style.background = `url("${maps[key]}") center / contain no-repeat`;
  save();
}


let dragTarget = null;
let dragOffset = { x: 0, y: 0 };

const map = document.getElementById("map");
const avatar = document.getElementById("avatar");
const modal = document.getElementById("modal");
const modalContent = document.getElementById("modalContent");
const context = document.getElementById("context");
const contextContent = document.getElementById("contextContent");

function save() {
  localStorage.setItem("rpgState", JSON.stringify(state));
}

setMap(state.currentMap || "mountain");

function getTouch(e) {
  return e.touches[0] || e.changedTouches[0];
}

function drawAvatar() {
  avatar.style.left = state.avatar.x + "px";
  avatar.style.top = state.avatar.y + "px";
}

function createPairedMilestone(type, x, y) {
  const pairedType = autoPairs[type];
  if (!pairedType) return;

  state.milestones.push({
    id: Date.now() + Math.random(),
    title: "",
    type: pairedType,
    tasks: [],
    x: x + 80,
    y: y
  });
}


function drawMilestones() {
  document.querySelectorAll(".milestone").forEach(e => e.remove());

  state.milestones.forEach(m => {
    const el = document.createElement("div");
    m._el = el;
    el.className = "milestone " + m.type;
    el.style.left = m.x + "px";
    el.style.top = m.y + "px";

    const img = document.createElement("img");
    img.src = icons[m.type];
    el.appendChild(img);

    el.onclick = e => {
      if (!e.altKey) openMilestone(m);
    };

    el.onmousedown = e => {
      if (!e.altKey) return;
      dragTarget = m;
      dragOffset.x = e.clientX - m.x;
      dragOffset.y = e.clientY - m.y;
      e.preventDefault();
    };
    
el.ontouchstart = e => {
  if (isModalOpen()) return;
  if (e.touches.length !== 1) return;

  const t = e.touches[0];
  touchMoved = false;
  touchStartX = t.clientX;
  touchStartY = t.clientY;

  dragTarget = m;
  dragOffset.x = t.clientX - m.x;
  dragOffset.y = t.clientY - m.y;

  e.preventDefault();
};



el.ontouchmove = e => {
  if (!dragTarget) return;

  const t = e.touches[0];

  const dx = Math.abs(t.clientX - touchStartX);
  const dy = Math.abs(t.clientY - touchStartY);

  if (dx > 6 || dy > 6) {
    touchMoved = true;
  }

  if (!touchMoved) return;

  dragTarget.x = t.clientX - dragOffset.x;
  dragTarget.y = t.clientY - dragOffset.y;

  dragTarget._el.style.left = dragTarget.x + "px";
  dragTarget._el.style.top = dragTarget.y + "px";
};

    map.appendChild(el);
  });
}

function openMilestone(m) {
  killDrag();

  modalContent.innerHTML = `
    <input value="${m.title || ""}" placeholder="${milestoneHelp[m.type] || ""}">
  `;
  const titleInput = modalContent.querySelector("input");

  titleInput.oninput = e => {
    m.title = e.target.value;
    save();
  };



  m.tasks.forEach((t, i) => {
    const row = document.createElement("div");
    row.className = "task";

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = t.done;
    cb.onchange = () => { t.done = cb.checked; save(); };

    const text = document.createElement("span");
    text.textContent = t.text;
    text.onclick = () => {
      const val = prompt("Edit task", t.text);
      if (val !== null) { t.text = val; save(); openMilestone(m); }
    };

    const del = document.createElement("button");
    del.textContent = "ðŸ—‘";
    del.onclick = () => {
      m.tasks.splice(i,1);
      save();
      openMilestone(m);
    };

    row.append(cb, text, del);
    modalContent.appendChild(row);
  });

  const add = document.createElement("input");
  add.placeholder = "New task â†’ Enter";
  add.onkeydown = e => {
    if (e.key === "Enter" && add.value.trim()) {
      m.tasks.push({ text: add.value, done: false });
      save();
      openMilestone(m);
    }
  };
  modalContent.appendChild(add);

  const delMilestone = document.createElement("button");
  delMilestone.className = "danger";
  delMilestone.textContent = "Delete Milestone";
  delMilestone.onclick = () => {
    state.milestones = state.milestones.filter(x => x !== m);
    save();
    modal.style.display = "none";
    drawMilestones();
  };

  delMilestone.style.alignSelf = "flex-end";
  modalContent.appendChild(delMilestone);
  modal.style.display = "flex";
}

avatar.onclick = e => {
  if (isDraggingAvatar || e.altKey) return;
  killDrag();

  modalContent.innerHTML = `

    <input value="${state.avatar.name}">
    <textarea placeholder="Notes">${state.avatar.notes}</textarea>
  `;
  modalContent.querySelector("input").onchange = e => {
    state.avatar.name = e.target.value; save();
  };
  modalContent.querySelector("textarea").onchange = e => {
    state.avatar.notes = e.target.value; save();
  };
  modal.style.display = "flex";
};


map.oncontextmenu = e => {
  e.preventDefault();
  contextContent.innerHTML = `
    <input id="title" placeholder="">
    <select id="type">
      ${Object.keys(icons).map(k => `<option value="${k}">${k}</option>`).join("")}
    </select>
    <button>Create</button>
  `;
  context.style.display = "flex";
  
  const titleInput = document.getElementById("title");
const typeSelect = document.getElementById("type");

titleInput.placeholder = milestoneHelp[typeSelect.value];

typeSelect.onchange = () => {
  titleInput.placeholder = milestoneHelp[typeSelect.value];
};


  contextContent.querySelector("button").onclick = () => {
    state.milestones.push({
      id: Date.now(),
      title: document.getElementById("title").value || "",
      type: document.getElementById("type").value,
      tasks: [],
      x: e.clientX - 24,
      y: e.clientY - 24
    });
    createPairedMilestone(
  document.getElementById("type").value,
  e.clientX - 24,
  e.clientY - 24
);

    save();
    context.style.display = "none";
    drawMilestones();
  };
};

window.onmousemove = window.ontouchmove = e => {
  if (!dragTarget) return;

  const p = e.touches ? getTouch(e) : e;
  dragTarget.x = p.clientX - dragOffset.x;
  dragTarget.y = p.clientY - dragOffset.y;

  if (dragTarget === state.avatar) {
    drawAvatar();
  } else {
    dragTarget._el.style.left = dragTarget.x + "px";
    dragTarget._el.style.top = dragTarget.y + "px";
  }
};




window.ontouchend = () => {
  if (!dragTarget) return;

  if (!touchMoved) {
  if (dragTarget === state.avatar) {
    openAvatar();
  } else {
    openMilestone(dragTarget);
  }
}


  save();
  dragTarget = null;
};

window.onmouseup = () => {
  if (!dragTarget) return;

  save();
  dragTarget = null;
  isDraggingAvatar = false;
};

avatar.onmousedown = e => {
  if (isModalOpen()) return;
  if (!e.altKey) return;

  isDraggingAvatar = true;
  dragTarget = state.avatar;
  dragOffset.x = e.clientX - state.avatar.x;
  dragOffset.y = e.clientY - state.avatar.y;
  e.preventDefault();
};

avatar.ontouchstart = e => {
  if (isModalOpen()) return;

  const t = getTouch(e);
  touchMoved = false;
  touchStartX = t.clientX;
  touchStartY = t.clientY;

  dragTarget = state.avatar;
  dragOffset.x = t.clientX - state.avatar.x;
  dragOffset.y = t.clientY - state.avatar.y;

  e.preventDefault();
};



avatar.ontouchend = e => {
  if (touchMoved) return;
  killDrag();

  modalContent.innerHTML = `

    <input value="${state.avatar.name}">
    <textarea placeholder="Notes">${state.avatar.notes}</textarea>
  `;

  modalContent.querySelector("input").onchange = e => {
    state.avatar.name = e.target.value; save();
  };

  modalContent.querySelector("textarea").onchange = e => {
    state.avatar.notes = e.target.value; save();
  };

  modal.style.display = "flex";
};

modal.onclick = e => {
  if (e.target === modal) modal.style.display = "none";
};


context.onclick = e => {
  e.stopPropagation();
  if (e.target === context) context.style.display = "none";
};


drawAvatar();
drawMilestones();

const mapSelect = document.getElementById("mapSelect");
mapSelect.value = state.currentMap;
mapSelect.onchange = e => setMap(e.target.value);

</script>

</body>
</html>
